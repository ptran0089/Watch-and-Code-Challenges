<script src="../simpletest.js"></script>
<meta charset="utf-8">
<script>

(function() {

  var libraryStorage = {};
  var cache = {};

  function librarySystem(libraryName, dependencies, callback) {

    var argsArr = [];

    if (arguments.length > 1) {

      if (libraryStorage[libraryName]) {
        return (libraryName + ' already exists.')
      }

      if (dependencies.every(function(item) {return libraryStorage[item];})) {             // Checks if the required libraries are in libraryStorage
        dependencies.forEach(function(dependency) {
          argsArr.push(libraryStorage[dependency]);                                        // If true, store in libraryStorage
        });
        libraryStorage[libraryName] = callback.apply(null, argsArr);

      } else {
        cache[libraryName] = {                                                              // If false, store in temporary cache 
          dependencies: dependencies, 
          callback: callback
        }
      } 

    } else if (arguments.length === 1) {

      if (libraryName in cache && cache[libraryName].dependencies.every(function(item) {return libraryStorage[item];})) {  // Checks if libraryName is in cache
        cache[libraryName].dependencies.forEach(function(dependency) {                                                     // and if the required libraries are
          argsArr.push(libraryStorage[dependency]);                                                                        // in libraryStorage
        })
        libraryStorage[libraryName] = cache[libraryName].callback.apply(null, argsArr);                                    // If true, move library from cache to 
      }                                                                                                                    // libraryStorage

      return libraryStorage[libraryName];
    }
      
  };

  window.librarySystem = librarySystem;

})();

tests({

  'librarySystem(\'workBlurb\') will only invoke when the required dependent libraries are in libraryStorage': function() {


    librarySystem('name', [], function() {
      return 'Gordon';
    });
    librarySystem('workBlurb', ['name', 'company'], function(name, company) {
      return name + ' works at ' + company;
      count++;
    });
    librarySystem('workBlurb');
    librarySystem('company', [], function() {
      return 'Watch and Code';
    });
    eq(librarySystem('workBlurb'), 'Gordon works at Watch and Code');

  },

  'Libraries can be created out of order': function() {

    librarySystem('workBlurb', ['name', 'company'], function(name, company) {
      return name + ' works at ' + company;
    });
    librarySystem('name', [], function() {
      return 'Gordon';
    });
    librarySystem('company', [], function() {
      return 'Watch and Code';
    });
    eq(librarySystem('workBlurb'), 'Gordon works at Watch and Code');

  },

  'It should be able to create a library system and call a library': function() {

    librarySystem('name', [], function() {
      return 'Gordon';
    });
    eq(librarySystem('name'), 'Gordon');

  },

  'The library systems should be able to depend on each other ': function() {

    librarySystem('name', [], function() {
      return 'Gordon';
    })
    librarySystem('company', [], function() {
      return 'Watch and Code';
    })
    librarySystem('workBlurb', ['name', 'company'], function(name, company) {
      return name + ' works at ' + company;
    })
    eq(librarySystem('workBlurb'), "Gordon works at Watch and Code");

  },

  'Callback function for each library should only run once': function() {

    var count = 0;

    librarySystem('name', [], function() {
      return 'Gordon';
      count++;
    })
    librarySystem('company', [], function() {
      return 'Watch and Code';
    })
    librarySystem('workBlurb', ['name', 'company'], function(name, company) {
      return name + ' works at ' + company;
      count++;
    })
    eq(librarySystem('workBlurb'), "Gordon works at Watch and Code");
    eq(librarySystem('workBlurb'), "Gordon works at Watch and Code");
    eq(count, 1);

  }

});
</script>

